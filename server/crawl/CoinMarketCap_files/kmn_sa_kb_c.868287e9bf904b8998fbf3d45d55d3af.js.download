"use strict";var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(a){return typeof a}:function(a){return a&&typeof Symbol==="function"&&a.constructor===Symbol?"symbol":typeof a};var _createClass=function(){function a(e,c){for(var b=0;b<c.length;b++){var d=c[b];d.enumerable=d.enumerable||false;d.configurable=true;if("value" in d){d.writable=true}Object.defineProperty(e,d.key,d)}}return function(d,b,c){if(b){a(d.prototype,b)}if(c){a(d,c)}return d}}();function _possibleConstructorReturn(a,b){if(!a){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return b&&(typeof b==="object"||typeof b==="function")?b:a}function _inherits(b,a){if(typeof a!=="function"&&a!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof a)}b.prototype=Object.create(a&&a.prototype,{constructor:{value:b,enumerable:false,writable:true,configurable:true}});if(a){Object.setPrototypeOf?Object.setPrototypeOf(b,a):b.__proto__=a}}function _classCallCheck(a,b){if(!(a instanceof b)){throw new TypeError("Cannot call a class as a function")}}var KmnUtils=function(){function q(){_classCallCheck(this,q)}_createClass(q,null,[{key:"createIframe",value:function b(G){var F=arguments.length>1&&arguments[1]!==undefined?arguments[1]:document.head;var E=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{};var H=document.createElement("iframe");Object.keys(E).forEach(function(I){H[I]=E[I]});F.appendChild(H);if(G){H.contentWindow.document.open();H.contentWindow.document.write(G);H.contentWindow.document.close()}}},{key:"createInvisibleIframe",value:function o(){var E=document.createElement("iframe");E.id=Math.random().toString(16).substr(2);E.height=0;E.width=0;E.border="0px";E.hspace="0";E.vspace="0";E.marginWidth="0";E.marginHeight="0";E.style.border="0";E.scrolling="no";E.frameBorder="0";E.src="about:blank";E.style.display="none";return E}},{key:"createScriptTag",value:function v(H,F,E){H=typeof H!=="undefined"?H:false;F=typeof F!=="undefined"?F:false;E=typeof E!=="undefined"?E:false;var G=document.createElement("script");if(H){G.src=H}if(F){G.innerHTML=F}if(E){G.async=true}return G}},{key:"pushTagToTag",value:function e(E,F){F.appendChild(E)}},{key:"pushScriptTagToHead",value:function p(H,G,F){var E=q.createScriptTag(H,G,F);q.pushTagToTag(E,document.head)}},{key:"buildQueryStringFromParams",value:function D(F){for(var E in F){if(F.hasOwnProperty(E)){if(!F[E]){delete F[E]}}}return Object.keys(F).map(function(G){return G+"="+F[G]}).join("&")}},{key:"kmn_ts",value:function h(){return new Date().getTime()}},{key:"url_with_querystring",value:function C(E){var G=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var F="?";Object.keys(G).forEach(function(H){F+=encodeURIComponent(H)+"="+encodeURIComponent(G[H])+"&"});return E+F.slice(0,-1)}},{key:"calcHash",value:function j(F,E){var G=JSON.stringify(F)+E;return q.hashCode(G)}},{key:"hashCode",value:function y(I){var H=0,F,G,E;if(I.length===0){return H}for(F=0,E=I.length;F<E;F++){G=I.charCodeAt(F);H=(H<<5)-H+G;H|=0}return H>0?H+"A":-H+"B"}},{key:"site_url",value:function t(){var F="",E="";F=E=window.location.href;if(F.indexOf("javascript:window")!==-1||F.indexOf("about:blank")!==-1){try{F=window.parent.location.href}catch(G){F=E}}if(F.length>1024){F=F.replace(/([^:]+:\/\/[^/]+).*/,"$1")}return F}},{key:"setAttributes",value:function z(F,E){try{Object.keys(E).forEach(function(H){F.setAttribute(H,E[H])});return F}catch(G){return F}}},{key:"extend",value:function B(){var E={};for(var F=arguments.length,G=Array(F),H=0;H<F;H++){G[H]=arguments[H]}if(G.length>0){G.forEach(function(I){Object.keys(I).forEach(function(J){E[J]=E[J]||I[J]})})}return E}},{key:"spark",value:function A(H){try{var E=this.extend({v:kmn_hb_options.v,cb:kmn_cb,ds:document.readyState},H);E.d=this.site_url();this.log("sprk"+JSON.stringify(E));var G=kmn_hb_options.baseUrlStatServer;kmn_cstat_kb.save(G,E);return E}catch(F){q.log("spark ERR:"+F.message)}}},{key:"isDebug",value:function x(){try{var G=0,I=0,F=window.location.href,E=F.slice(F.indexOf("?")+1).split("&");for(;G<E.length;G++){if(E[G]==="kmn-hb-debug=true"){I=1}}kmn_hb_options.debugMode=I;if(I&&!window.console){window.console={log:function H(){}}}}catch(J){}}},{key:"log",value:function i(G){if(kmn_hb_options.debugMode){var F=new Date(),E=F.getHours()+":"+F.getMinutes()+":"+F.getSeconds()+":"+F.getMilliseconds();console.log("["+E+"] "+G)}}},{key:"logIfNeededStringify",value:function n(H,F){if(kmn_hb_options.debugMode){var G=new Date(),E=G.getHours()+":"+G.getMinutes()+":"+G.getSeconds()+":"+G.getMilliseconds();console.log("["+E+"] "+H+" "+JSON.stringify(F))}}},{key:"detectMobile",value:function w(){var E=false;if(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|ipad|iris|kindle|Android|Silk|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(window.navigator.userAgent)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(window.navigator.userAgent.substr(0,4))){E=true}return E}},{key:"RoundToPrecision",value:function s(F,E){E=E||1000;return Math.round(F*E)/E}},{key:"generateCB",value:function m(){return Math.floor(new Date().getTime()%65536+Math.floor(Math.random()*65536)*65536)}},{key:"isArray",value:function l(E){return Object.prototype.toString.call(E)==="[object Array]"}},{key:"getPath",value:function f(E,F){return E.reduce(function(H,G){return H&&typeof H[G]!=="undefined"?H[G]:null},F)}},{key:"vivify",value:function d(I,H,G){var E=arguments.length>3&&arguments[3]!==undefined?arguments[3]:false;if(I){var F=H.slice(-1);H.slice(0,-1).forEach(function(J){I[J]=I[J]||{};I=I[J]});I[F]=typeof I[F]!=="undefined"&&!E?I[F]:G}}},{key:"filterObj",value:function k(F,E){return Object.keys(F).filter(E).reduce(function(H,G){return H[G]=F[G],H},{})}},{key:"isLocalStorageUsable",value:function c(){return q.isStorageUsable("localStorage")}},{key:"isSessionStorageUsable",value:function u(){return q.isStorageUsable("sessionStorage")}},{key:"isStorageUsable",value:function a(F){if(typeof Storage!=="undefined"&&typeof window[F]!=="undefined"){var E="test";try{window[F].setItem(E,E);window[F].removeItem(E);return true}catch(G){}}return false}},{key:"addIfExists",value:function g(G,E,F){var H=arguments.length>3&&arguments[3]!==undefined?arguments[3]:F;if(typeof E[F]!=="undefined"){G[H]=E[F]}}},{key:"mAddIfExists",value:function r(G,E,F){F.forEach(function(H){return q.addIfExists(G,E,H)})}}]);return q}();var kmn_hb_options=KmnUtils.extend(window.kmn_hb_options||{},{debugMode:false,kmn_sa_use_option:false,prebidTimeout:window.PREBID_TIMEOUT||1000,v:"2.0.24",cdnMode:true,cdnKbVersion:"0.1",baseCdnUrl:"//s.komoona.com/kb/",maxBid:1000,minBid:0.011,minBidForCounters:0.011,saveCachedBids:true,baseUrlHbServer:"//hb.komoona.com",baseUrlS2S:"//s2s.komoona.com",baseUrlStatServer:"//stat.komoona.com/s",kmn_sa_url:"//cdn.komoona.com/scripts/kmn_sa.js",kmn_sa_options:{}});(function setCdnResponseIfItExists(a){if(a!=="$$HB CONF$$".replace(" ","_")){kmn_hb_options.cdnResponse=a}})({"data_ver":"0.1","kbidder_configs":[{"rules":[{"ruletype":"device","negate":true,"rulevalues":["mobile"]}],"value":{"hdbddata":[{"network":"openx","is_s2s":false,"adslots":[{"placement":"0c749a3c08941c23619df0ff76b1369a","code":"e1","config":{"auid":"539134597","width":"160","height":"600"}},{"placement":"33eca0b682f2126a30349bd7e25ad093","code":"e1","config":{"auid":"539134602","width":"300","height":"250"}},{"placement":"386e40457d4a1238421745637817317d","code":"e1","config":{"auid":"539134596","width":"728","height":"90"}},{"placement":"46244a0b40d08e3aef1f82dfd1224fc7","code":"e1","config":{"auid":"539134600","width":"320","height":"50"}},{"placement":"6a01d6c9636c64974c4ee0c189c81ecc","code":"e1","config":{"auid":"539134606","width":"728","height":"90"}},{"placement":"6bbb1cc2adf61b899b86d6873177719c","code":"e1","config":{"auid":"539134601","width":"320","height":"50"}},{"placement":"84660597a22525c53f643d470b84a8b8","code":"e1","config":{"auid":"539134598","width":"728","height":"90"}},{"placement":"d4f97ef8e935be2ebaa6d104b735a236","code":"e1","config":{"auid":"539134607","width":"320","height":"50"}},{"placement":"ec8fb804f5166e4a4a2f1c9b52e9f882","code":"e1","config":{"auid":"539134603","width":"728","height":"90"}},{"placement":"ee5f2ce74bd3babf2d1f9f7ff593a974","code":"e1","config":{"auid":"539134604","width":"160","height":"600"}},{"placement":"f809727556f52e6542373b7cc73ba5c5","code":"e1","config":{"auid":"539134605","width":"320","height":"50"}}]},{"network":"pubmatic","is_s2s":true,"adslots":[{"placement":"0c749a3c08941c23619df0ff76b1369a","code":"p1","config":{"key":"coinmarketcap_PNQ0_160x600@160x600","account":"156262","is_s2s":true}},{"placement":"33eca0b682f2126a30349bd7e25ad093","code":"p1","config":{"key":"coinmarketcap_PY9S_300x250@300x250","account":"156262","is_s2s":true}},{"placement":"386e40457d4a1238421745637817317d","code":"p1","config":{"key":"coinmarketcap_8EAG_728x90@728x90","account":"156262","is_s2s":true}},{"placement":"46244a0b40d08e3aef1f82dfd1224fc7","code":"p1","config":{"key":"coinmarketcap_KANW_320x50@320x50","account":"156262","is_s2s":true}},{"placement":"6a01d6c9636c64974c4ee0c189c81ecc","code":"p1","config":{"key":"coinmarketcap_0OS4_728x90@728x90","account":"156262","is_s2s":true}},{"placement":"6bbb1cc2adf61b899b86d6873177719c","code":"p1","config":{"key":"coinmarketcap_6EOD_320x50@320x50","account":"156262","is_s2s":true}},{"placement":"84660597a22525c53f643d470b84a8b8","code":"p1","config":{"key":"coinmarketcap_UPGH_728x90@728x90","account":"156262","is_s2s":true}},{"placement":"d4f97ef8e935be2ebaa6d104b735a236","code":"p1","config":{"key":"coinmarketcap_WCZJ_320x50@320x50","account":"156262","is_s2s":true}},{"placement":"ec8fb804f5166e4a4a2f1c9b52e9f882","code":"p1","config":{"key":"coinmarketcap_2EKX_728x90@728x90","account":"156262","is_s2s":true}},{"placement":"ee5f2ce74bd3babf2d1f9f7ff593a974","code":"p1","config":{"key":"coinmarketcap_DWR3_160x600@160x600","account":"156262","is_s2s":true}},{"placement":"f809727556f52e6542373b7cc73ba5c5","code":"p1","config":{"key":"coinmarketcap_B9E5_320x50@320x50","account":"156262","is_s2s":true}}]},{"network":"taboola","is_s2s":true,"adslots":[{"placement":"0c749a3c08941c23619df0ff76b1369a","code":"U1"},{"placement":"33eca0b682f2126a30349bd7e25ad093","code":"U1"},{"placement":"386e40457d4a1238421745637817317d","code":"U1"},{"placement":"46244a0b40d08e3aef1f82dfd1224fc7","code":"U1"},{"placement":"6a01d6c9636c64974c4ee0c189c81ecc","code":"U1"},{"placement":"6bbb1cc2adf61b899b86d6873177719c","code":"U1"},{"placement":"84660597a22525c53f643d470b84a8b8","code":"U1"},{"placement":"d4f97ef8e935be2ebaa6d104b735a236","code":"U1"},{"placement":"ec8fb804f5166e4a4a2f1c9b52e9f882","code":"U1"},{"placement":"ee5f2ce74bd3babf2d1f9f7ff593a974","code":"U1"},{"placement":"f809727556f52e6542373b7cc73ba5c5","code":"U1"}]}],"hblogic":{"placementsLogic":{"0c749a3c08941c23619df0ff76b1369a":{"width":"160","height":"600","a":0.693,"c":0,"fl":{"config":{"sample":0.01692},"codes":[{"code":"p1","sample":0.73901,"methods":{"npc":{"npcc":100,"npcth":0}}},{"code":"U1","sample":0.00497,"methods":{"npc":{"npcc":100,"npcth":0},"npr":{"active":true}}},{"code":"e1","sample":0.45391,"methods":{"npc":{"npcc":100,"npcth":0}}}]}},"33eca0b682f2126a30349bd7e25ad093":{"width":"300","height":"250","a":0.674,"c":0,"fl":{"config":{"sample":0.02271},"codes":[{"code":"U1","sample":0.00662,"methods":{"npc":{"npcc":100,"npcth":0},"npr":{"active":true}}},{"code":"p1","sample":0.73864,"methods":{"npc":{"npcc":100,"npcth":0}}},{"code":"e1","sample":0.77058,"methods":{"npc":{"npcc":100,"npcth":0}}}]}},"386e40457d4a1238421745637817317d":{"width":"728","height":"90","a":0.695,"c":0,"fl":{"config":{"sample":0.01691},"codes":[{"code":"p1","sample":0.72179,"methods":{"npc":{"npcc":100,"npcth":0}}},{"code":"U1","sample":0.00497,"methods":{"npc":{"npcc":100,"npcth":0},"npr":{"active":true}}},{"code":"e1","sample":0.40194,"methods":{"npc":{"npcc":100,"npcth":0}}}]}},"46244a0b40d08e3aef1f82dfd1224fc7":{"width":"320","height":"50","a":0.663,"c":0,"fl":{"config":{"sample":0.01443},"codes":[{"code":"e1","sample":0.83269,"methods":{"npc":{"npcc":100,"npcth":0}}},{"code":"U1","sample":0.00601,"methods":{"npc":{"npcc":100,"npcth":0},"npr":{"active":true}}},{"code":"p1","methods":{"npc":{"npcc":100,"npcth":0}}}]}},"6a01d6c9636c64974c4ee0c189c81ecc":{"width":"728","height":"90","a":0.631,"c":0,"fl":{"config":{"sample":0.01562},"codes":[{"code":"U1","sample":0.00573,"methods":{"npc":{"npcc":100,"npcth":0},"npr":{"active":true}}},{"code":"e1","sample":0.54501,"methods":{"npc":{"npcc":100,"npcth":0}}},{"code":"p1","methods":{"npc":{"npcc":100,"npcth":0}}}]}},"6bbb1cc2adf61b899b86d6873177719c":{"width":"320","height":"50","a":0.68,"c":0,"fl":{"config":{"sample":0.02208},"codes":[{"code":"U1","sample":0.00645,"methods":{"npc":{"npcc":100,"npcth":0},"npr":{"active":true}}},{"code":"p1","sample":0.5082,"methods":{"npc":{"npcc":100,"npcth":0}}},{"code":"e1","sample":0.42576,"methods":{"npc":{"npcc":100,"npcth":0}}}]}},"84660597a22525c53f643d470b84a8b8":{"width":"728","height":"90","a":0.699,"c":0,"fl":{"config":{"sample":0.01691},"codes":[{"code":"e1","sample":0.40669,"methods":{"npc":{"npcc":100,"npcth":0}}},{"code":"U1","sample":0.00497,"methods":{"npc":{"npcc":100,"npcth":0},"npr":{"active":true}}},{"code":"p1","sample":0.67661,"methods":{"npc":{"npcc":100,"npcth":0}}}]}},"d4f97ef8e935be2ebaa6d104b735a236":{"width":"320","height":"50","a":0.678,"c":0,"fl":{"config":{"sample":0.02208},"codes":[{"code":"U1","sample":0.00645,"methods":{"npc":{"npcc":100,"npcth":0},"npr":{"active":true}}},{"code":"e1","sample":0.41487,"methods":{"npc":{"npcc":100,"npcth":0}}},{"code":"p1","sample":0.50218,"methods":{"npc":{"npcc":100,"npcth":0}}}]}},"ec8fb804f5166e4a4a2f1c9b52e9f882":{"width":"728","height":"90","a":0.548,"c":0,"fl":{"config":{"sample":0.01563},"codes":[{"code":"p1","sample":0.00573,"methods":{"npc":{"npcc":100,"npcth":0},"npr":{"active":true}}},{"code":"U1","sample":0.00573,"methods":{"npc":{"npcc":100,"npcth":0},"npr":{"active":true}}},{"code":"e1","sample":0.55745,"methods":{"npc":{"npcc":100,"npcth":0}}}]}},"ee5f2ce74bd3babf2d1f9f7ff593a974":{"width":"160","height":"600","a":0.576,"c":0,"fl":{"config":{"sample":0.01562},"codes":[{"code":"U1","sample":0.00573,"methods":{"npc":{"npcc":100,"npcth":0},"npr":{"active":true}}},{"code":"e1","sample":0.66498,"methods":{"npc":{"npcc":100,"npcth":0}}},{"code":"p1","methods":{"npc":{"npcc":100,"npcth":0}}}]}},"f809727556f52e6542373b7cc73ba5c5":{"width":"320","height":"50","a":0.672,"c":0,"fl":{"config":{"sample":0.01443},"codes":[{"code":"p1","methods":{"npc":{"npcc":100,"npcth":0}}},{"code":"U1","sample":0.00601,"methods":{"npc":{"npcc":100,"npcth":0},"npr":{"active":true}}},{"code":"e1","sample":0.75127,"methods":{"npc":{"npcc":100,"npcth":0}}}]}}},"cid":"937b42c470cb0b98aa584500d4ddf7f1","rb":{"rate":0.25},"domain":"coinmarketcap.com","fl":{"active":true,"methods":{"ts":{"level":2,"config":{"tsth":4000}},"npr":{"level":2,"config":{}},"npc":{"level":2,"config":{}},"gf":{"level":2,"config":{}},"qf":{"level":2,"config":{}}}},"cm":{"pubmatic":0.91}}}}]});var kmn_cstat_kb=window.kmn_cstat_kb||new function(){var b=this;b.async_js=function(f,d){try{var g,c=document.createElement("script");KmnUtils.setAttributes(c,KmnUtils.extend(d||{},{src:f,async:true,type:"text/javascript"}));g=document.getElementsByTagName("head")[0];if(g){g.appendChild(c)}return c}catch(h){KmnUtils.log("async_js ERR:"+h.message)}};b.url_with_querystring=function a(c){var e=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var d="?";Object.keys(e).forEach(function(f){d+=encodeURIComponent(f)+"="+encodeURIComponent(e[f])+"&"});return c+d.slice(0,-1)};b.save=function(d,h){try{var g=b.url_with_querystring(d,h),c=b.async_js(g,{});c.onload=c.onreadystatechange=function(){var e=c.readyState;if(!e||e==="loaded"||e==="complete"){c.onload=c.onreadystatechange=null;if(c.parentNode){c.parentNode.removeChild(c)}}};return c}catch(f){}}}();var KmnKB=function(){function k(A,z,y){var w=arguments.length>3&&arguments[3]!==undefined?arguments[3]:window.pbjs;_classCallCheck(this,k);if(w){w.kmnHdbdHandlers={};var x="";this.hdbdid=A;this.hb_placements=z;this.globalPbjsObject=w;this.kmn_bids_logic=y;if(!kmn_hb_options.cdnResponse){if(kmn_hb_options.cdnMode){x=kmn_hb_options.baseCdnUrl+"/"+kmn_hb_options.cdnKbVersion+"/"+A+".js"}else{x=kmn_hb_options.baseUrlHbServer+"/hdbd/id/"+A+"?callback=kmn_hdbd.kmnHdbdCb&cb="+kmn_cb+"&placements="+this.hb_placements.toString()}KmnUtils.log("dbg: Call hb server/cdn : "+x);KmnUtils.pushScriptTagToHead(x)}}else{KmnUtils.log("ERROR: no pbjs on page (might be using a different name which was not passed in)");KmnUtils.spark({err:"noPbjs@ctor"})}}_createClass(k,[{key:"getBidstore",value:function d(){return this.kmn_bids_logic.getBidstore()}},{key:"kmnHdbdCdnCb",value:function p(w){var z=w.kbidder_configs[0].value;if(w.kbidder_configs.length>1){var y=KmnUtils.detectMobile();var A=0,C=false;while(A<w.kbidder_configs.length&&!C){var x=0;var D=w.kbidder_configs[A];while(x<D.rules.length&&!C){if(D.rules[x].ruletype=="device"){Object.keys(D.rules[x].rulevalues).forEach(function(E){if(D.rules[x].rulevalues[E]==="mobile"&&!y==D.rules[x].negate){z=D.value;C=true}})}x++}A++}}var B=(typeof z==="undefined"?"undefined":_typeof(z))==="object"?z:JSON.parse(z);B=JSON.parse(JSON.stringify(B));B.hdbddata=this.filterNetworkAdslots(B.hdbddata);B.hdbddata=this.filterNoAdslots(B.hdbddata);B.hblogic.placementsLogic=this.filterPlacementLogic(B.hblogic.placementsLogic,window.kmn_hdbd.hb_placements);window.kmn_hdbd.kmnHdbdCb(B)}},{key:"filterNoAdslots",value:function h(w){w=w.filter(function(x){return x.adslots.length>0});return w}},{key:"filterPlacementLogic",value:function i(x,w){return w.filter(function(y){return x[y]}).reduce(function(y,z){y[z]=x[z];return y},{})}},{key:"filterNetworkAdslots",value:function t(w){w.forEach(function(x){x.adslots=x.adslots.filter(function(y){return window.kmn_hdbd.hb_placements.some(function(z){return y.placement===z})})});return w}},{key:"kmnHdbdCb",value:function j(x){var z=this;try{KmnUtils.logIfNeededStringify("Got response from HB server:",x);this.kmn_bids_logic.addHdbdServerResponse(x);var w=this._gatherAllHdbdData(x.hdbddata);w.forEach(function(A){try{z._handleGatheredNetworkData(A)}catch(B){KmnUtils.spark({err:"hndlr@kmnHdbdCb",msg:B.message})}});this._useCachedBids()}catch(y){KmnUtils.spark({err:"tag@kmnHdbdCb",msg:y.message})}}},{key:"_handleGatheredNetworkData",value:function u(y){var x=this;var w=[];var z=[];if(y.adslots){y.adslots.forEach(function(B){var A=x.kmn_bids_logic.applyFilterToAdSlot(B);B.filtering=A;if(A.isFiltered){KmnUtils.log("Adslot is filtered out fl="+A.fl+" flr="+A.flr+" pl="+B.placement+" code="+B.code);w.push(B)}else{KmnUtils.log("Adslot is NOT filtered out fl="+A.fl+" pl="+B.placement+" code="+B.code);z.push(B)}})}if(z.length>0){y.adslots=z;this.createHdbdHandlers(y)}if(w.length>0){this.kmn_bids_logic.addRequestData(w)}}},{key:"_gatherAllHdbdData",value:function e(x){var z=x.filter(function(B){return !B.is_s2s});var A=x.filter(function(B){return B.is_s2s});var w=[];if(z.length>0){w=k.gatherRequestsNotS2S(z)}if(A.length>0){var y=k.gatherRequestsS2S(A);w.push(y)}return w}},{key:"_useCachedBids",value:function l(){var y=this;if(this.kmn_bids_logic.isBidCaching()){var x=this.loadBidsForReuse();var w=this;Object.keys(x).filter(function(z){return x[z]}).forEach(function(A){var z=y._getCachedBidForPlacement(A);if(z){KmnUtils.log("checkingToPrebid cachedBid, code="+z.code);w.kmn_bids_logic.CheckStoredBidToPrebid(z,A)}})}}},{key:"_getCachedBidForPlacement",value:function m(z){var w=null;if(this.getBidstore()){var x=this.getBidstore().getBidstoreDataForPlacement(z);if(x){var y=Object.keys(x).filter(function(A){return x[A].rb});if(y.length==1){w=x[y[0]]}else{if(y.length>1){KmnUtils.spark({err:"tooMany@rb"})}}}}return w}},{key:"saveBidsForReuse",value:function r(w){try{if(!(w.constructor===Array)){return}var x=[];w.forEach(function(A){var z=ReuseBid.addParamsForReuse(A);x.push(z)});ReuseBid.saveBidsToStorage(x)}catch(y){KmnUtils.spark({err:"error@saveBidsForReuse",msg:y.message})}}},{key:"loadBidsForReuse",value:function a(){try{var y=KmnUtils.kmn_ts();var C=ReuseBid.loadAllFromStorage();if(Object.keys(C).length>0){var x=this.kmn_bids_logic.getBidstorePlacementIds();C=ReuseBid.filterByPlacements(C,x);var A=10;C=ReuseBid.filterByTimePassed(C,ReuseBid.minSecsToReuseBid,A);var w=KmnUtils.kmn_ts()-y;KmnUtils.log("loadBidsForReuse: loading bids for reuse took "+w+" miliseconds");KmnUtils.logIfNeededStringify("Going to save the bids after converting them to bids store objects: ",C);var z=this.kmn_bids_logic.addReuseBidsData(C,w);return z}}catch(B){KmnUtils.spark({err:"error@loadBidsForReuse",msg:B.message})}return{}}},{key:"notifyBidUsed",value:function n(y,x){var w=false;try{KmnUtils.log("notifyBidUsed called to remove:  "+x+" of placement "+y);var A=ReuseBid.loadAllFromStorage();var B=ReuseBid.deleteBidFromObject(A,y,x);if(B){ReuseBid.saveAllToStorage(B);w=true}}catch(z){KmnUtils.spark({err:"err@notifyBidUsed",msg:z.message})}return w}},{key:"handlersFactory",value:function c(y){var x=null;var w=y&&y.network_server?y.network_server:null;switch(w){case"pubmatic":x=kmnPubmaticHandler;break;case"cpx":case"defy":x=kmnApnHandler;break;case"sovrn":x=kmnSovrnHandler;break;case"openx":x=kmnOpenxHandler;break;case"s2s":x=kmnS2SHandler;break;case"rhythmone":x=kmnRhythmOneHandler;break;default:KmnUtils.log("Ignoring request to create unknown handler for "+w)}return x}},{key:"createHdbdHandlers",value:function q(z){if(z&&z.network_server){var y=this.handlersFactory(z);if(y!=null){var w=this;y.startHdbdRequests(z,function x(A,B){var C=A.id;w.globalPbjsObject.kmnHdbdHandlers[C]=A;KmnUtils.log("Added handler with id "+C);w.kmn_bids_logic.addRequestData(B)})}}}},{key:"saveHdbdHandlerResponseData",value:function v(x){var w=this.kmn_bids_logic.addResponseData(x);if(kmn_hb_options.saveCachedBids){this.saveBidsForReuse(w)}}}],[{key:"start",value:function f(x,w){window.kmn_cb=KmnUtils.generateCB();if(typeof x=="undefined"&&typeof window.kmn_hb_callback!="undefined"){x={hdbdid:window.kmn_hbid,hb_placements:window.kmn_hb_placements,hb_placement_bidids:window.kmn_hb_placement_bidids,ts_as:window.kmn_ts_as,kb_callback:window.kmn_hb_callback,encode_bid:window.kmn_encode_bid}}if(typeof x!="undefined"){window.kmn_bids_logic=KmnBidsLogic.start(x);window.kmn_hdbd=new k(x.hdbdid,x.hb_placements,window.kmn_bids_logic,w);KmnUtils.isDebug();KmnUtils.log("dbg: head: starting KmnKB with  window params params: id ["+x.hdbdid+"], placements ["+x.hb_placements+"],  callback ["+x.kb_callback+"]");if(kmn_hb_options.cdnResponse){KmnUtils.log("dbg: not calling cdn! config is already here");window.kmn_hdbd.kmnHdbdCdnCb(kmn_hb_options.cdnResponse)}}}},{key:"setFl",value:function s(w,x){if(w){ImpressionFilter.block(x)}else{ImpressionFilter.unblock()}}},{key:"cs",value:function g(y,w){var x="//cdn.komoona.com/sync/";var z=void 0;var A={};switch(y){case"p":z="//ads.pubmatic.com/AdServer/js/user_sync.html";A={p:"156262",predirect:w?"":x+y+"s?"+y+"="};break;default:KmnUtils.spark({err:"unk@cs",msg:y})}if(z&&document&&document.head){var B=KmnUtils.createInvisibleIframe();B.setAttribute("id","kmn_cs_"+y);B.src=KmnUtils.url_with_querystring(z,A);KmnUtils.pushTagToTag(B,document.head)}}},{key:"gatherRequestsNotS2S",value:function o(w){w.forEach(function(y){y.network_server=y.network;if(y.adslots){for(var x=0;x<y.adslots.length;x++){y.adslots[x].network=y.network_server}}});return w}},{key:"gatherRequestsS2S",value:function b(w){var x={is_s2s:true,network_server:"s2s",adslots:[]};w.forEach(function(A){var z=A.network;if(A.adslots){for(var y=0;y<A.adslots.length;y++){var B=A.adslots[y];B.network=z;x.adslots.push(B)}}});return x}}]);return k}();var KmnAjax=function(){function d(){_classCallCheck(this,d);this.reqfields=["responseType","withCredentials","timeout","onprogress"];this.global=window;this._XDR=false}_createClass(d,[{key:"ajax",value:function c(h,r){var f=h.headers||{},l=h.body,e=h.method||(l?"POST":"GET"),p=false;var n=this.getRequest(h.cors);function g(i,s){return function(){if(!p){r(n.status===undefined?i:n.status,n.status===0?"Error":n.response||n.responseText||s,n);p=true}}}n.open(e,h.url,true);var q=n.onload=g(200);n.onreadystatechange=function(){if(n.readyState===4){q()}};n.onerror=g(null,"Error");n.ontimeout=g(null,"Timeout");n.onabort=g(null,"Abort");if(l){this.setDefault(f,"X-Requested-With","XMLHttpRequest");if(!this.global.FormData||!(l instanceof this.global.FormData)){this.setDefault(f,"Content-Type","application/x-www-form-urlencoded")}}for(var j=0,m=this.reqfields.length,o;j<m;j++){o=this.reqfields[j];if(h[o]!==undefined){if(o!=="withCredentials"||!this._XDR){n[o]=h[o]}}}for(var k in f){n.setRequestHeader(k,f[k])}n.send(l);return n}},{key:"getRequest",value:function b(e){if(e&&this.global.XDomainRequest&&!/MSIE 1/.test(this.global.navigator.userAgent)){this._XDR=true;return new XDomainRequest()}if(this.global.XMLHttpRequest){this._XDR=false;return new XMLHttpRequest()}}},{key:"setDefault",value:function a(g,e,f){g[e]=g[e]||f}}]);return d}();var kmnBaseHandler=function(){function a(d){_classCallCheck(this,a);this.myadSlots=d;this.network=d[0].network;this.id=this.generateId(d)}_createClass(a,[{key:"_buildBidObject",value:function b(g,e,h,d){var f=arguments.length>4&&arguments[4]!==undefined?arguments[4]:false;return{adslot:g,cpm:e,creative_data:h,bid_id:KmnUtils.calcHash(h,g.placement),network:g.network,error:d,isAuctioned:f}}}],[{key:"startHdbdRequests",value:function c(k,j){var g=this.splitDataToAdSlotsGroups(k);for(var f=0;f<g.length;f++){var h=this;var d=new h(g[f]);j(d,g[f]);try{d.createHdbdRequest()}catch(l){KmnUtils.spark({err:"req@hdbd",msg:l.message})}}}}]);return a}();var kmnApnHandler=function(a){_inherits(g,a);function g(h){_classCallCheck(this,g);return _possibleConstructorReturn(this,(g.__proto__||Object.getPrototypeOf(g)).call(this,h))}_createClass(g,[{key:"generateId",value:function c(h){var i=this.network+"_"+h[0].code+"_"+h[0].placement;return i}},{key:"createHdbdRequest",value:function f(){var h="window.parent.kmn_hdbd.globalPbjsObject.kmnHdbdHandlers."+this.id+".readHdbdResponse";var l=this.myadSlots[0].config.size;var i=this.myadSlots[0].config.ssp_placementid;var k=encodeURIComponent(window.top.location.href);KmnUtils.log("dbg: "+this.network+" url referrer : "+k);var j="";j+="<html><head>";j+="<script src='http"+(document.location.protocol==="https:"?"s://secure.adnxs.com/jpt?":"://ib.adnxs.com/jpt?")+"id="+i+"&size="+l+"&referrer="+k+"&callback="+h+"'><\/script></head><body></body></html>";KmnUtils.createIframe(j)}},{key:"readHdbdResponse",value:function d(h){try{var i=this._apnResponseToBids(h);window.kmn_hdbd.saveHdbdHandlerResponseData(i)}catch(j){KmnUtils.spark({err:"tag@hb_readHdbdResponse_apn",msg:j.message})}}},{key:"_apnResponseToBids",value:function b(k){var i=this;var j=k&&k.result&&k.result.ad?[k.result]:[];KmnUtils.logIfNeededStringify(this.network+" callback->bidDetailsMap:",j);var h={network_server:this.network,bids:[]};if(!j||j.length===0){h.bids.push(this._buildBidObject(this.myadSlots[0],0,{},"no bids returned from "+this.network))}else{j.forEach(function(l){var m=i._buildBidObject(i.myadSlots[0],l.cpm/10000,{creative:l.ad});h.bids.push(m)})}return h}}],[{key:"splitDataToAdSlotsGroups",value:function e(i){KmnUtils.logIfNeededStringify("dbg: split function called with ",i);var h=[];if(i.adslots){i.adslots.forEach(function(j){KmnUtils.logIfNeededStringify("dbg : adslot is ",[j]);h.push([j])})}KmnUtils.log("dbg: "+JSON.stringify(h));return h}}]);return g}(kmnBaseHandler);var kmnSovrnHandler=function(c){_inherits(f,c);function f(i){_classCallCheck(this,f);return _possibleConstructorReturn(this,(f.__proto__||Object.getPrototypeOf(f)).call(this,i))}_createClass(f,[{key:"generateId",value:function a(i){var j="sovrn";return j}},{key:"createHdbdRequest",value:function g(){KmnUtils.log("creating HDBD request to sovrn");var k="window.parent.kmn_hdbd.globalPbjsObject.kmnHdbdHandlers."+this.id+".readHdbdResponse";var n={};n.id=this.id;n.imp=[];n.site={domain:window.location.host};for(var l=0;l<this.myadSlots.length;l++){var q=this.myadSlots[l];n.imp.push({id:q.config.ssp_placementid,banner:{w:q.config.width,h:q.config.height},tagid:q.config.ssp_placementid})}var m=Math.floor(1000+Math.random()*9000);if(!this.isHttps()){var j="//gslbeacon.lijit.com/beacon?viewId=Komoona_auction_api&rand="+m+"&informer=13386040&type=fpads&loc="+encodeURIComponent(window.location.href.replace(/.*?:\/\//g,""))+"&v=1.2";KmnUtils.createIframe(null,document.head,{src:j})}var p="//ap.lijit.com/rtb/bid?callback="+k+"&br="+encodeURIComponent(JSON.stringify(n));var o="<html><head><script src='"+p+"'><\/script></head><body></body></html>";KmnUtils.createIframe(o)}},{key:"isHttps",value:function h(){return document.location.protocol==="https:"}},{key:"readHdbdResponse",value:function b(k){try{var i=this._sovrnResponseToBids(k);window.kmn_hdbd.saveHdbdHandlerResponseData(i)}catch(j){KmnUtils.spark({err:"tag@hb_readHdbdResponse_sovrn",msg:j.message})}}},{key:"_sovrnResponseToBids",value:function e(o){KmnUtils.logIfNeededStringify("sovrn response to bids data: ",o);var j={network_server:"sovrn",bids:[]};var p={};if(o&&o.seatbid&&o.seatbid.length>0){o.seatbid.forEach(function(i){if(i.bid){i.bid.forEach(function(q){p[q.impid]=q})}})}for(var l=0;l<this.myadSlots.length;l++){var n=this.myadSlots[l];if(p[n.config.ssp_placementid]){var k=p[n.config.ssp_placementid];var m=this._buildBidObject(n,k.price,{creative:k.adm,nurl:k.nurl});j.bids.push(m)}else{j.bids.push(this._buildBidObject(n,0,{},"no bids returned from sovrn"))}}return j}}],[{key:"splitDataToAdSlotsGroups",value:function d(i){return[i.adslots]}}]);return f}(kmnBaseHandler);var kmnPubmaticHandler=function(e){_inherits(c,e);function c(i){_classCallCheck(this,c);return _possibleConstructorReturn(this,(c.__proto__||Object.getPrototypeOf(c)).call(this,i))}_createClass(c,[{key:"generateId",value:function b(i){var j="pub_"+i[0].config.account;return j}},{key:"createHdbdRequest",value:function h(){var j=this._jsToRunBefore();var i="";i+="<html><head><script>"+j+"<\/script>";i+="<script src='//ads.pubmatic.com/AdServer/js/gshowad.js'><\/script></head><body></body></html>";KmnUtils.createIframe(i)}},{key:"_jsToRunBefore",value:function a(){var j=this.myadSlots[0].config.account;var k=[];for(var l=0;l<this.myadSlots.length;l++){k.push(this.myadSlots[l].config.key)}var n=KmnUtils.site_url();var m="";m+="var pm_pub_id = "+j+";";m+="var pm_optimize_adslots = "+JSON.stringify(k)+";";m+='var kadpageurl="'+n+'";';m+="function kmnPbResponseHandlerInside() { ";m+="var params = {'bidDetailsMap' : bidDetailsMap, 'progKeyValueMap' : progKeyValueMap};";m+="if(window.parent.kmn_hdbd.globalPbjsObject && window.parent.kmn_hdbd.globalPbjsObject.kmnHdbdHandlers && window.parent.kmn_hdbd.globalPbjsObject.kmnHdbdHandlers['"+this.id+"']){";m+="window.parent.kmn_hdbd.globalPbjsObject.kmnHdbdHandlers['"+this.id+"'].readHdbdResponse(params);";m+="}";m+="}";m+="var pm_async_callback_fn = 'kmnPbResponseHandlerInside'";return m}},{key:"readHdbdResponse",value:function d(j){try{var i=this._pubmaticResponseToBids(j);window.kmn_hdbd.saveHdbdHandlerResponseData(i)}catch(k){KmnUtils.spark({err:"tag@hb_readHdbdResponse_pubmatic",msg:k.message})}}},{key:"_pubmaticResponseToBids",value:function f(m){var i=this;var l=m&&m.bidDetailsMap?m.bidDetailsMap:{};var k=m&&m.progKeyValueMap?m.progKeyValueMap:{};KmnUtils.log("pubmatic callback-> bidDetailsMap: "+JSON.stringify(l)+" progKeyValueMap: "+JSON.stringify(k));var j={network_server:"pubmatic",bids:[]};Object.keys(l).forEach(function(p){var n=i.myadSlots.filter(function(q){return q.config.key===p});if(n.length===1&&n[0].config&&n[0].config.key){var o=i._buildBidObject(n[0],l[p].ecpm,{bidsObject:l[p],pbkey:n[0].config.key});j.bids.push(o)}});return j}}],[{key:"splitDataToAdSlotsGroups",value:function g(k){var j=[];if(k.adslots){k.adslots.forEach(function(l){if(l.config&&l.config.account){if(!j[l.config.account]){j[l.config.account]=[]}j[l.config.account].push(l)}})}var i=Object.keys(j).map(function(l){return j[l]});return i}}]);return c}(kmnBaseHandler);var kmnOpenxHandler=function(k){_inherits(d,k);function d(m){_classCallCheck(this,d);var n=_possibleConstructorReturn(this,(d.__proto__||Object.getPrototypeOf(d)).call(this,m));n.startTime=new Date();return n}_createClass(d,[{key:"generateId",value:function j(m){var n="openx";return n}},{key:"createHdbdRequest",value:function f(){var o=this._buildRequestJson();var m="//"+d.KOMOONA_DOMAIN+"/w/1.0/arj";var p=KmnUtils.buildQueryStringFromParams(o);var n=m+"?"+p;KmnUtils.pushScriptTagToHead(n)}},{key:"_buildRequestJson",value:function b(){var m=window.self!==window.top;var o=encodeURIComponent(KmnUtils.site_url());var n={ju:o,jr:o,ch:document.charSet||document.characterSet,res:window.screen.width+"x"+window.screen.height+"x"+window.screen.colorDepth,ifr:m,tz:this.startTime.getTimezoneOffset(),tws:this._getViewportDimensions(m),ee:"api_sync_write",ef:"bt%2Cdb",be:1,bc:"hb_pb"};n.auid=this.myadSlots.filter(function(p){return p.config}).map(function(p){return p.config.auid}).join("%2C");n.aus=this.myadSlots.filter(function(p){return p.config}).map(function(p){return p.config.width+"x"+p.config.height}).join("|");n.callback="window.kmn_hdbd.globalPbjsObject.kmnHdbdHandlers."+this.id+".readHdbdResponse";return n}},{key:"_getViewportDimensions",value:function i(p){var o,n,r=window,q=document,s=q.documentElement,m;if(p){r=window.top;q=window.top.document;s=q.documentElement;m=q.body;o=r.innerWidth||s.clientWidth||m.clientWidth;n=r.innerHeight||s.clientHeight||m.clientHeight}else{s=q.documentElement;o=r.innerWidth||s.clientWidth;n=r.innerHeight||s.clientHeight}return o+"x"+n}},{key:"readHdbdResponse",value:function e(o){try{var m=this._openxResponseToBids(o);window.kmn_hdbd.saveHdbdHandlerResponseData(m)}catch(n){KmnUtils.spark({err:"tag@hb_readHdbdResponse_openx",msg:n.message})}}},{key:"_openxResponseToBids",value:function h(o){var q=this;KmnUtils.logIfNeededStringify("openx callback is here: "+JSON.stringify(o));if(o.ads&&o.ads.pixels){this._makePDCall(o.ads.pixels,null)}var p=o&&o.ads&&o.ads.ad?o.ads.ad:[];var m={network_server:"openx",bids:[]};var r=function r(u){var w=q.myadSlots[u];var x=w.config?w.config.auid:"";var t=p.filter(function(y){return y.adunitid.toString()===x});var s=t.length==1?t[0]:null;if(s){if(s.pub_rev){q._handleBeaconPixel(s);var v=q._buildBidObject(w,Number(s.pub_rev)/1000,{creative:s.html});m.bids.push(v)}else{m.bids.push(q._buildBidObject(w,0,{},"no cpm returned for that adslot from openx"))}}else{m.bids.push(q._buildBidObject(w,0,{},"no bids returned from openx"))}};for(var n=0;n<this.myadSlots.length;n++){r(n)}return m}},{key:"_handleBeaconPixel",value:function a(n){var o={bd:+new Date()-this.startTime,br:"0",bt:200,bs:window.location.hostname};if(n.pub_rev){o.br=o.bt<o.bd?"t":"p";o.bp=n.pub_rev;o.ts=n.ts}var m=n.creative&&Array.isArray(n.creative)?n.creative[0]:{};this._buildBoPixel(m,o)}},{key:"_buildBoPixel",value:function l(m,q){var p=new Image();var o=m&&m.tracking?m.tracking.impression:"";var n=o.match(/([^?]+\/)ri\?/);if(n){p.src=n[1]+"bo?"+KmnUtils.buildQueryStringFromParams(q)}}},{key:"_makePDCall",value:function g(p,q){var n=KmnUtils.createInvisibleIframe();var o="openx-pd";n.setAttribute("id",o);n.setAttribute("name",o);var m=document.body;if(!m){return}n.src=p;if(q){q.parentNode.replaceChild(n,q);q=n}else{q=m.appendChild(n)}}}],[{key:"splitDataToAdSlotsGroups",value:function c(m){KmnUtils.logIfNeededStringify("dbg: openx split function called with ",m);return[m.adslots]}}]);return d}(kmnBaseHandler);kmnOpenxHandler.KOMOONA_DOMAIN="komoona-d.openx.net";var kmnS2SHandler=function(g){_inherits(e,g);function e(k){_classCallCheck(this,e);return _possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,k))}_createClass(e,[{key:"generateId",value:function h(k){var l="s2s";return l}},{key:"createHdbdRequest",value:function d(){var p=this._buildRequestAllParams();var n=kmn_hb_options.baseUrlS2S;var k=KmnUtils.url_with_querystring(n+"/GetBids",p);var m=KmnUtils.createScriptTag(k);var o=m.outerHTML;var l="<html><head>"+o+"</head><body></body></html>";KmnUtils.createIframe(l)}},{key:"_buildRequestAllParams",value:function i(){var k="window.parent.kmn_hdbd.globalPbjsObject.kmnHdbdHandlers."+this.id+".readHdbdResponse";var l={cb:kmn_cb,callback:k,placements:this._buildPlacementsParam(),uts:KmnUtils.kmn_ts(),inFrame:0,url:KmnUtils.site_url(),tz:new Date().getTimezoneOffset()};return l}},{key:"_buildPlacementsParam",value:function f(){var k={};for(var m=0;m<this.myadSlots.length;m++){var l=this.myadSlots[m];if(!k[l.placement]){k[l.placement]=l.code}else{k[l.placement]+=","+l.code}}var n={placements:[]};Object.keys(k).forEach(function(p){var o={layoutid:p,codes:k[p]};n.placements.push(o)});return JSON.stringify(n)}},{key:"readHdbdResponse",value:function c(l){try{KmnUtils.logIfNeededStringify("s2s callback -> ",l);var k=this._s2sResponseToBids(l);window.kmn_hdbd.saveHdbdHandlerResponseData(k)}catch(m){KmnUtils.spark({err:"tag@hb_readHdbdResponse_s2s",msg:m.message})}}},{key:"_s2sResponseToBids",value:function j(o){var n=this;var k={network_server:"s2s",bids:[]};if(!o.results||!KmnUtils.isArray(o.results)){if(o.error){KmnUtils.log("Error message from s2s : "+o.error)}var l=o.error,m=l===undefined?"Empty Non Array Response from S2S":l;k.bids=this.myadSlots.map(function(p){return n._errorS2SResponse(p,m)})}else{o.results.forEach(function(B){var s=n.myadSlots.filter(function(C){return C.code===B.code&&C.placement===B.placementid});if(s.length>1){k.bids.push(n._errorS2SResponse(s,"found more than 1 adslot"))}else{if(s.length<1){k.bids.push(n._errorS2SResponse(s,"no adslots found for "+JSON.stringify(B)))}else{var u=B.firstPrice,p=u===undefined?0:u,v=B.secPrice,z=v===undefined?0:v,q=B.cpm,y=q===undefined?0:q,r=B.creative,x=r===undefined?"":r,w=B.error,A=w===undefined?"":w;var t=y!=0?n._buildBidObject(s[0],y,{creative:x},A):n._buildBidObject(s[0],p,{creative:x,cpm_second:z},A,true);k.bids.push(t)}}})}return k}},{key:"_errorS2SResponse",value:function a(l,k){return this._buildBidObject(l,0,{},k)}}],[{key:"splitDataToAdSlotsGroups",value:function b(k){return[k.adslots]}}]);return e}(kmnBaseHandler);var kmnRhythmOneHandler=function(h){_inherits(l,h);function l(m){_classCallCheck(this,l);var n=_possibleConstructorReturn(this,(l.__proto__||Object.getPrototypeOf(l)).call(this,m));n.ro_fat=/(^v|(\.0)+$)/gi;n.ro_version="0.9.0.0";n.loadStart=new Date().getTime();n._placementCodeToParams={};return n}_createClass(l,[{key:"generateId",value:function i(m){var n="rhythmone";return n}},{key:"createHdbdRequest",value:function e(){try{var t="mvo";var s=this.myadSlots[0].config.ssp_domain_id;var q="//tag.1rx.io/rmp/"+s+"/0/"+t;var p=this._getQueryParams();var o=KmnUtils.url_with_querystring(q,p);KmnUtils.logIfNeededStringify("calling ro");var m=this;new KmnAjax().ajax({url:o,withCredentials:true,headers:{"Content-Type":"text/plain"},cors:true},function n(v,w){var u={code:v,responseText:w};m.readHdbdResponse(u)})}catch(r){KmnUtils.spark({err:"ajax@ro",msg:r.message})}}},{key:"readHdbdResponse",value:function c(n){KmnUtils.logIfNeededStringify("RO callback -> ",n);try{var p=true;if(n.code==200){this._sendAuditBeacon(this.myadSlots[0].config.placementId)}else{p=false}var m=this._responseToBids(n.responseText,p);window.kmn_hdbd.saveHdbdHandlerResponseData(m)}catch(o){KmnUtils.spark({err:"tag@hb_readHdbdResponse_ro",msg:o.message})}}},{key:"_responseToBids",value:function g(r,u){var m=this;var v=void 0;if(u&&r){try{v=JSON.parse(r)}catch(q){KmnUtils.spark({err:"parse@hb_readHdbdResponse_ro",msg:q.message,data:encodeURIComponent(r)})}}var t={network_server:"rhythmone",bids:[]};if(!v){var n={error:"non 200 response fm ro or parse error"};t.bids=this.myadSlots.map(function(w){return m._errorS2SResponse(w,n)})}else{for(var p=0;v.seatbid&&p<v.seatbid.length;p++){var s=function s(y){var x=void 0,C=void 0,z=void 0;x=v.seatbid[p].bid[y];C=m._placementCodeToParams[x.impid];try{z=parseFloat(x.price)}catch(B){}var A=void 0;var w=m.myadSlots.filter(function(D){return D.code===C.code&&D.placement===C.placement});if(w.length>1){A=m._errorS2SResponse(w,"found more than 1 adslot")}else{if(w.length<1){A=m._errorS2SResponse(w,"no adslots found for "+JSON.stringify(v))}else{if(typeof z!=="undefined"){A=m._buildBidObject(w[0],z,{creative:x.adm,width:x.w,height:x.h},"")}else{A=m._errorS2SResponse(w[0],"can't parse cpm "+JSON.stringify(x.price))}}}t.bids.push(A)};for(var o=0;v.seatbid[p].bid&&o<v.seatbid[p].bid.length;o++){s(o)}}}return t}},{key:"_errorS2SResponse",value:function a(n,m){return this._buildBidObject(n,0,{},m)}},{key:"_flashInstalled",value:function k(){var v=window.navigator,u=v.plugins,q=v.mimeTypes,r="application/x-shockwave-flash",o=window.ActiveXObject;if(u&&u["Shockwave Flash"]&&q&&q[r]&&q[r].enabledPlugin){return true}if(o){try{if(new window.ActiveXObject("ShockwaveFlash.ShockwaveFlash")){return true}}catch(s){}}return false}},{key:"attempt",value:function f(o){var m=arguments.length>1&&arguments[1]!==undefined?arguments[1]:"";try{return o()}catch(n){}return m}},{key:"_getQueryParams",value:function j(){var A={};function q(C,p){if(p instanceof Array){p=p.join(",")}if(typeof p!=="undefined"){A[C]=p}}var z="1r";q("z",z);q("domain",this.attempt(function(){var p=window.document.location.ancestorOrigins;if(p&&p.length>0){return p[p.length-1]}return window.top.document.location.hostname}));q("title",this.attempt(function(){return window.top.document.title}));q("url",this.attempt(function(){var p;try{p=window.top.document.location.href.toString()}catch(C){p=window.document.location.href.toString()}return p}));q("dsh",window.screen?window.screen.height:"");q("dsw",window.screen?window.screen.width:"");q("tz",new Date().getTimezoneOffset());q("dtype",/(ios|ipod|ipad|iphone|android)/i.test(window.navigator.userAgent)?1:/(smart[-]?tv|hbbtv|appletv|googletv|hdmi|netcast\.tv|viera|nettv|roku|\bdtv\b|sonydtv|inettvbrowser|\btv\b)/i.test(window.navigator.userAgent)?3:2);var B=[],r=[],v=[],x=[],t=[],u=0;var n=[];try{n=window.kmn_hdbd.globalPbjsObject.adUnits.map(function(p){return p.code})}catch(y){}var s=KmnUtils.getPath(["kmn_hdbd","globalPbjsObject","version"],window);for(;u<this.myadSlots.length;u++){var o=[],w=[];w.push(this.myadSlots[u].config.w);o.push(this.myadSlots[u].config.h);B.push(o.join("|"));r.push(w.join("|"));x.push("d");v.push(0);var m=n&&n[u]?n[u]:u;t.push(m);this._placementCodeToParams[m]={code:this.myadSlots[u].code,placement:this.myadSlots[u].placement}}q("imp",t);q("w",r);q("h",B);q("floor",v);return A}},{key:"_sendAuditBeacon",value:function d(t){try{var p={doc_version:1,doc_type:"Prebid Audit",placement_id:t},r=document.location.ancestorOrigins,m=[],x="//hbevents.1rx.io/audit?",s=new Image();if(r&&r.length>0){p.ancestor_origins=r[r.length-1]}p.popped=window.opener!==null?1:0;p.framed=window.top===window?0:1;try{p.url=window.top.document.location.href.toString()}catch(w){p.url=window.document.location.href.toString()}var n=window.kmn_hdbd.globalPbjsObject;if(n){if(n.version){p.prebid_version=n.version.replace(this.ro_fat,"")}p.placement_codes=n.adUnits.map(function(q){return q.code});p.prebid_timeout=n.cbTimeout||n.bidderTimeout}p.response_ms=new Date().getTime()-this.loadStart;p.bidder_version=this.ro_version;for(var o in p){m.push(encodeURIComponent(o)+"="+encodeURIComponent(_typeof(p[o])==="object"?JSON.stringify(p[o]):p[o]))}m.sort();s.src=x+m.join("&")}catch(v){KmnUtils.spark({err:"aud@ro",msg:v.message})}}}],[{key:"splitDataToAdSlotsGroups",value:function b(m){return[m.adslots]}}]);return l}(kmnBaseHandler);var KmnBidsStore=function(){function t(){_classCallCheck(this,t);KmnUtils.log("bids_store: starting");this.data={start_time:KmnUtils.kmn_ts(),spark_sent:false,placements:{}};this.startReceiving()}_createClass(t,[{key:"setStartTime",value:function s(w){this.data.start_time=w}},{key:"getBidstoreData",value:function a(){return this.data}},{key:"getBidstoreDataForPlacement",value:function p(w){if(this.data.placements&&this.data.placements[w]){return this.data.placements[w]}return null}},{key:"addRequestData",value:function e(w){KmnUtils.logIfNeededStringify("bids_store: got request data with adSlotsInRequest: ",w);for(var x=0;x<w.length;x++){var y=w[x];if(!this.data.placements[y.placement]){this.data.placements[y.placement]={}}this.data.placements[y.placement][y.code]={returned:false,network:y.network,code:y.code,placementid:y.placement,filtering:y.filtering,reqts:this._hb_tp()}}KmnUtils.logIfNeededStringify("bids_store: store data after adding request data:",this.data)}},{key:"addResponseData",value:function h(w){KmnUtils.logIfNeededStringify("bids_store: got bidsData response ",w);var C=[];if(w.bids){for(var y=0;y<w.bids.length;y++){var B=w.bids[y];if(B.adslot&&B.adslot.placement&&this.data.placements[B.adslot.placement]){var A=B.adslot?B.adslot.code:null;var x=B.rb&&A?this._getCachedBidKey(A):A;if(x&&this.data.placements[B.adslot.placement][x]){var z=this.data.placements[B.adslot.placement][x];z.returned=true;z.cpm=B.cpm;z.creative_data=B.creative_data;z.bid_id=B.bid_id;z.network_server=z.network_server||w.network_server;z.network=z.network||B.network;z.rests=this._hb_tp();z.cpm_to_use=B.cpm_to_use;z.sb=B.actualBidCpm;KmnUtils.addIfExists(z,B,"grossAuctionPrice","gap");KmnUtils.addIfExists(z,B,"netAuctionPrice","nap");KmnUtils.addIfExists(z,B,"firstPrice","fp");KmnUtils.addIfExists(z,B,"secondPriceType","spt");C.push(z)}}}}KmnUtils.logIfNeededStringify("bids_store: store data after adding response data:",this.data);return C}},{key:"_xformStoreFormatToSendBidsFormat",value:function m(x,w,z){var y={adslot:{placement:w,code:x.code}};y.cpm=x.cpm;y.creative_data=x.creative_data;y.network=x.network;KmnUtils.addIfExists(y,x,"bid_id");KmnUtils.addIfExists(y,x,"sb","actualBidCpm");KmnUtils.addIfExists(y,x,"cpm_to_use");KmnUtils.addIfExists(y,x,"gap","grossAuctionPrice");KmnUtils.addIfExists(y,x,"nap","netAuctionPrice");KmnUtils.addIfExists(y,x,"fp","firstPrice");KmnUtils.addIfExists(y,x,"spt","secondPriceType");if(z){y.rb=true}return y}},{key:"addReuseBidsData",value:function g(C,A){var B=this.data.rb={rbt:A};var x={};for(var z in C){if(C.hasOwnProperty(z)){var w=false;var y=this._getMaxBid(C[z]);if(y){this.addReusedBidToSparkData(B,z,y);w=this.addReusedBidToBidData(z,y)}x[z]=w}}KmnUtils.logIfNeededStringify("Saving bids for reuse to bids logic:",C);return x}},{key:"_getMaxBid",value:function q(x){if(x){var B=Object.keys(x);var A=B.length;if(A>0){var w=x[B[0]];if(A>1){var z=B.every(function(C){return typeof x[C].sb!=="undefined"})?"sb":"cpm";var y=B.reduce(function(D,C){return x[D][z]>x[C][z]?D:C});w=x[y]}return w}}return null}},{key:"_getCachedBidKey",value:function c(w){return w+"_rb"}},{key:"addReusedBidToBidData",value:function i(y,x){if(x&&x.code&&x.cpm>0){x.returned=true;x.reqts=this._hb_tp();x.rests=x.reqts;x.rb=true;var w=this._getCachedBidKey(x.code);if(!this.data.placements[y]){this.data.placements[y]={}}this.data.placements[y][w]=x;return true}return false}},{key:"addReusedBidToSparkData",value:function r(y,x,w){y[x]={};y[x].rbc=w.code;y[x].rbb=w.cpm;y[x].rbid=w.bid_id}},{key:"startReceiving",value:function l(){KmnUtils.log("bids_store: listening");var w=this;window.addEventListener("message",function(x){w._receiveMessage(x)})}},{key:"getPlacementIds",value:function b(){return Object.keys(this.data.placements)}},{key:"_hb_tp",value:function v(){var w=KmnUtils.kmn_ts();return w-this.data.start_time}},{key:"notifyBidUsed",value:function o(x,w){kmn_hdbd.notifyBidUsed(x,w)}},{key:"_HBData",value:function u(z){var w=this._hb_tp();var y={msg_type:"hdbdData",hdbd_data:{hb_tp:w,placement_id:z}};if(this.data.placements[z]){var x=this.data.placements[z];y.hdbd_data.hbbids=x}return y}},{key:"_receiveMessage",value:function n(w){try{if(w&&w.data&&w.data.msg_type=="hdbdRequest"){KmnUtils.logIfNeededStringify("bids_Store recieved message!",w.data);if(w.data.params&&w.data.params.placement_id!==undefined){var y=this._HBData(w.data.params.placement_id);this._sendResponse(w,y)}}}catch(x){KmnUtils.spark({err:"tag@hb_receiveMessage",msg:x.message})}}},{key:"_sendResponse",value:function f(x,w){KmnUtils.logIfNeededStringify(" bids_Store sending new message: ",w);x.source.postMessage(w,x.origin)}},{key:"_didAllReturn",value:function d(){var w=this;if(this.data.placements){if(Object.keys(this.data.placements).length===0){return false}return Object.keys(this.data.placements).every(function(x){return Object.keys(w.data.placements[x]).every(function(y){return w.data.placements[x][y].returned||w.data.placements[x][y].filtering&&w.data.placements[x][y].filtering.isFiltered})})}return false}},{key:"_didAllPlacementReturn",value:function k(x){var w=this;if(!this.data.placements[x]){return false}return Object.keys(this.data.placements[x]).every(function(y){return w.data.placements[x][y].returned||w.data.placements[x][y].filtering&&w.data.placements[x][y].filtering.isFiltered})}}],[{key:"start",value:function j(){return new t()}}]);return t}();var KmnBidsLogic=function(){function t(){_classCallCheck(this,t);KmnUtils.log("bids_logic: starting");this.logicData={start_time:KmnUtils.kmn_ts(),spark_sent:false,data:{}};this.filterer=null;window.kmn_bids_store=KmnBidsStore.start();this.startLogicSparkTimeout()}_createClass(t,[{key:"setConfig",value:function C(af){var ae=this.logicData;ae.callback=af.kb_callback;ae.start_time=af.ts_as||ae.start_time;ae.encode_bid=af.encode_bid;ae.hb_placements=af.hb_placements;ae.hb_placement_bidids=af.hb_placement_bidids;if(af.hb_floors){ae.hb_floors=af.hb_floors}}},{key:"getFloorForPlacement",value:function z(ae){if(this.logicData.hb_floors&&this.logicData.hb_floors[ae]&&!isNaN(this.logicData.hb_floors[ae])&&this.logicData.hb_floors[ae]>0){return this.logicData.hb_floors[ae]}return 0}},{key:"getBidstore",value:function F(){return window.kmn_bids_store}},{key:"addHdbdServerResponse",value:function e(af){var ae=this;KmnUtils.logIfNeededStringify("Saving logic data:",af);this.addBidsLogicData(af.hblogic);this.splitPlacementsCodes(af.hdbddata);this.filterer=new ImpressionFilterLogic(af.hblogic.fl,this._logic_tp());var ai=void 0;if(this.getConfigPlacementIds()){var ah=this.getConfigPlacementIds();ai=ah.map(function(aj){return ae.applyFilterToPlacement(aj)})}this.addFilteringPageResult(ai);var ag=this.prepareKbDataSpark();KmnUtils.spark(ag);return ag}},{key:"prepareKbDataSpark",value:function o(){var ag={kbdata:1,kb_pl:this.getConfigPlacementIds(),sbt:this.logicData.sbtMode,hb_tp:this._logic_tp(),hbtype:"kbidder"};if(this.logicData.cid){ag.cid=this.logicData.cid}this._fillFilteringParamsArrayToSpark(ag,this.logicData.fl_page_result);var ah=["hb_placement_bidids","hb_placements","fl_page_result","cm","cid","auctionList"];var af=this;var ae=Object.keys(this.logicData).filter(function(ai){return ah.indexOf(ai)===-1}).reduce(function(ai,aj){ai[aj]=af.logicData[aj];return ai},{});ag.logicdata=JSON.stringify(ae);return ag}},{key:"addFilteringPageResult",value:function c(ae){this.logicData.fl_page_result=ae}},{key:"applyFilterToPlacement",value:function N(ag){var ae={};if(ag&&this.filterer){var af=this.logicData.data[ag]?this.logicData.data[ag].fl:{};ae=this.filterer.apply(af)}return ae}},{key:"applyFilterToAdSlot",value:function u(ag){var ae={};if(this.filterer){if(ag){var af=this.logicData.data[ag.placement]?this.logicData.data[ag.placement].fl:{};return this.filterer.apply(af,ag)}}return ae}},{key:"addBidsLogicData",value:function ab(ai){var af=this;var ae=this.logicData;ae.data=ai.placementsLogic;ae.cm=ai.cm||{};ae.rb=ai.rb||{};ae.rb.rate=typeof ae.rb.rate!=="undefined"?ae.rb.rate:0;if(ae.rb.rate>=0&&ae.rb.rate<=1){ae.rb.active=Math.random()<ae.rb.rate?true:false}else{ae.rb.active=false}if(ai.fl){ae.fl_config=ai.fl}if(ai.cid){ae.cid=ai.cid}if(typeof ai.sbt_factors!=="undefined"&&ai.sbt_factors.no_wait_prop&&ai.sbt_factors.no_wait_prop>0){if(Math.random()>ai.sbt_factors.no_wait_prop){ai.sbt=ai.sbt_factors.suggested_bidtime}}else{if(typeof ai.sbt_factors!=="undefined"&&ai.sbt_factors.suggested_bidtime){ai.sbt=ai.sbt_factors.suggested_bidtime}}ae.sbt=ai.sbt||null;ae.sbtMode=ae.sbt?true:false;if(ae.sbtMode){var ah=ae.sbt-this._logic_tp();if(ah>0){var ag=this;setTimeout(function(){ag.sendBidsSbtMode()},ah);KmnUtils.log("sbtMode: actualSbt:"+ah)}else{ae.sbtMode=false}}Object.keys(ae.data).forEach(function(ak){ae.data[ak].a=ae.data[ak].a||0.8;ae.data[ak].c=ae.data[ak].c||0;ae.data[ak].codes=[];if(!ae.sbtMode){var aj=af;setTimeout(function(){aj.checkNoBid(ak)},kmn_hb_options.prebidTimeout-50)}})}},{key:"isBidCaching",value:function U(){if(this.logicData&&this.logicData.rb&&this.logicData.rb.active){return true}return false}},{key:"addReuseBidsData",value:function M(af,ae){return this.getBidstore().addReuseBidsData(af,ae)}},{key:"splitPlacementsCodes",value:function ac(af){var ae=this;af.forEach(function(ag){ag.adslots.forEach(function(ah){ae.logicData.data[ah.placement].codes.push(ah.code)})})}},{key:"sendBidsSbtMode",value:function r(){var ae=this;this.logicData.sbtMode=false;Object.keys(this.logicData.data).forEach(function(ag){var af=ae.logicData.data[ag];if(af&&af.sbtBid){ae._callPBJSCallback(ag,af.sbtBid,af.sbtBidLog,"(sbtmode)");af.sbtBid=null}else{if(ae._sentBidsCount(ag)===0){ae.sendNoBidOrNoAvailBid(ag)}}})}},{key:"checkNoBid",value:function I(ae){if(ae&&this.logicData.data[ae]&&this._sentBidsCount(ae)===0){this.sendNoBidOrNoAvailBid(ae)}}},{key:"sendNoBidOrNoAvailBid",value:function E(af){var ae=this.logicData.data[af];if(ae){this.SendNoBidAvailableToPrebid(af)}}},{key:"addRequestData",value:function G(ae){this.getBidstore().addRequestData(ae)}},{key:"addResponseData",value:function T(ae){var af=this;if(!ae.bids){return[]}ae.bids.forEach(function(ah){ah.actualBidCpm=typeof ah.actualBidCpm!=="undefined"?ah.actualBidCpm:af._calculateActualCpm(ah,ah.cpm_to_use?ah.cpm_to_use:ah.cpm)});var ag=this.getBidstore().addResponseData(ae);ae.bids.forEach(function(ai){var ah=ai.cpm&&ai.cpm>kmn_hb_options.minBidForCounters?true:false;try{ImpressionFilter.updateNetworkResponse(ai.network,ai.adslot.placement,ah);if(!af.logicData.firstResponseReceived){af.logicData.firstResponseReceived=true;ImpressionFilter.updateGlobalCounterRequest(ai.adslot.placement)}if(ah&&!af.logicData.firstValidBidReceived){af.logicData.firstValidBidReceived=true;ImpressionFilter.updateGlobalCounterBid(ai.adslot.placement)}}catch(aj){KmnUtils.spark({err:"pc@sa_kb",msg:""+aj.message})}af.CheckBidToPrebid(ai)});return ag}},{key:"getConfigPlacementIds",value:function l(){return this.logicData.hb_placements}},{key:"getBidstorePlacementIds",value:function q(){return this.getBidstore().getPlacementIds()}},{key:"_calculateCpmAfterMargin",value:function Y(ag,ae){var af=KmnUtils.getPath(["data",ag,"a"],this.logicData);af=af||1;return KmnUtils.RoundToPrecision(af*ae,10000)}},{key:"_calculateCpmBeforeMargin",value:function J(af,ae){return KmnUtils.RoundToPrecision(ae/this._calculateCpmAfterMargin(af,1),10000)}},{key:"_calculetCpmAfterCommission",value:function n(af,ae){return KmnUtils.RoundToPrecision(ae*this._getNetworkMultiplier(af.network),10000)}},{key:"_calculateCpmBeforeCommission",value:function Z(af,ae){return KmnUtils.RoundToPrecision(ae/this._calculetCpmAfterCommission(af,1),10000)}},{key:"_calculateActualCpm",value:function y(ah,ae){var ag=arguments.length>2&&arguments[2]!==undefined?arguments[2]:true;var ai=ag?this._calculetCpmAfterCommission(ah,ae):ae;var af=this._calculateCpmAfterMargin(ah.adslot.placement,ai);return af}},{key:"_getNetworkMultiplier",value:function s(ae){return this.logicData.cm[ae]>0?this.logicData.cm[ae]:1}},{key:"CheckStoredBidToPrebid",value:function aa(ae,ag){var af=this.getBidstore()._xformStoreFormatToSendBidsFormat(ae,ag,true);this.CheckBidToPrebid(af)}},{key:"addBidToAuctionList",value:function K(ae){var ah=ae.adslot.placement;if(!this.logicData.auctionList){this.logicData.auctionList={}}if(!this.logicData.auctionList[ah]){this.logicData.auctionList[ah]=[]}var ag=this.logicData.auctionList[ah];var af={bidResponse:ae,first:this.getBidCpms(ae)};if(this.isAuctionedResponse(ae)){af.second=this.getBidCpms(ae,true);af.isAuctioned=true}else{af.second=af.first;af.isAuctioned=false}ag.push(af)}},{key:"performAuction",value:function f(aj,aq){var ap=this.logicData.auctionList&&this.logicData.auctionList[aj]?this.logicData.auctionList[aj]:null;var ar={winningBid:null,secondPriceBid:0,secondPriceNet:0};var ao=void 0;if(ap&&ap.length>0){var am=ap.slice().sort(function(au,at){return at.first.netCpm-au.first.netCpm});var ae=ap.slice().sort(function(au,at){return at.second.netCpm-au.second.netCpm});var ai=am[0];var af=ai.first.netCpm;var al=am.length>1?am[1]:null;var ah=ae[0];var an=void 0,ak=void 0;if(al&&al.first.netCpm>ah.second.netCpm){an=al;ak=al.first.netCpm;ao="1"}else{an=ah;ak=ah.second.netCpm;ao="2"}var ag=Math.min(Math.max(ak+0.01,aq),af);if(aq>ak+0.01){ao="f"}ar={winningBid:ai,secondPriceBid:an,secondPriceNet:ag,secondPriceType:ao}}return ar}},{key:"CheckBidToPrebid",value:function P(ah){var aj=ah.adslot.placement;var af=this.logicData.data[aj];if(ah.cpm>kmn_hb_options.minBid){this.addBidToAuctionList(ah);var ae=this.getFloorForPlacement(aj);var ai=this._calculateCpmBeforeMargin(aj,ae);var ag=this.performAuction(aj,ai);var ak=this._generateWinningResponse(ag,aj);if(this._shouldSendBidToPrebid(ak,ae,aj)){af.highestPlacementBid=ak.actualBidCpm;this.SendBidToPrebid(ak)}else{if(ak.actualBidCpm>kmn_hb_options.maxBid){KmnUtils.spark({err:"OverMaxBidCap@kmn_sa_kb",msg:"bid over cap: "+ak.actualBidCpm})}}}if(this.getBidstore()._didAllPlacementReturn(aj)){this.allPlacementsReturned(aj)}}},{key:"_generateWinningResponse",value:function O(af,ag){var ae=af.secondPriceNet;var ah=JSON.parse(JSON.stringify(af.winningBid.bidResponse));ah.netAuctionPrice=ae;ah.actualBidCpm=this._calculateCpmAfterMargin(ag,ae);ah.grossAuctionPrice=this._calculateCpmBeforeCommission(af.secondPriceBid.bidResponse,ae);if(this.isAuctionedResponse(ah)){ah.firstPrice=ah.cpm;ah.secondPriceType=af.secondPriceType}return ah}},{key:"_shouldSendBidToPrebid",value:function W(ah,ae,ag){var af=this.logicData.data[ag];return ah.actualBidCpm>=ae&&ah.actualBidCpm<=kmn_hb_options.maxBid&&(typeof af.highestPlacementBid=="undefined"||ah.actualBidCpm>af.highestPlacementBid)}},{key:"allPlacementsReturned",value:function X(af){var ae=this.logicData.data[af];if(this.logicData.sbtMode&&ae.sbtBid){this._callPBJSCallback(af,ae.sbtBid,ae.sbtBidLog,"(sbtmode - all returned)");ae.sbtBid=null}else{if(this._sentBidsCount(af)===0){this.sendNoBidOrNoAvailBid(af)}}}},{key:"isAuctionedResponse",value:function D(ae){return ae.cpm&&ae.creative_data&&ae.creative_data.cpm_second}},{key:"getBidSecondPrice",value:function i(ae){if(ae.creative_data&&ae.creative_data.cpm_second){return ae.creative_data.cpm_second}return 0}},{key:"getBidCpms",value:function m(ah){var ai=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;var ae=ai?this.getBidSecondPrice(ah):ah.cpm;var ag=this._calculetCpmAfterCommission(ah,ae);var af=this._calculateCpmAfterMargin(ah.adslot.placement,ag);return{grossCpm:ae,netCpm:ag,actualCpm:af}}},{key:"SendBidToPrebid",value:function x(aj){var ak=aj.adslot.placement;this.getBidstore().addResponseData({bids:[aj]});var ai=this.getBidstore()._HBData(ak);var ae=this._generateHdbdJson(kmn_cb,aj.adslot.code,aj.cpm_to_use?aj.cpm_to_use:aj.cpm,aj.network,ai,aj.actualBidCpm);var ah=this.createCreative(kmn_hb_options.kmn_sa_use_option,kmn_hb_options.kmn_sa_options,ak,ae,kmn_hb_options.kmn_sa_url);var af={cpm:aj.actualBidCpm,height:this.logicData.data[ak].height,width:this.logicData.data[ak].width,placementid:aj.adslot.placement,creative:ah};var ag={cpm:aj.cpm_to_use?aj.cpm_to_use:aj.cpm,code:aj.adslot.code,bid_src:aj.network,sent_bid:af.cpm,sbt:this.logicData.sbtMode};if(aj.rb){ag.rb=aj.rb}if(this.logicData.sbtMode){this.SaveBidToSbtBid(ak,af,ag)}else{this._callPBJSCallback(ak,af,ag)}}},{key:"SendNoBidAvailableToPrebid",value:function B(ah){var ai=this.logicData.data[ah];var ae=this._generateHdbdJson(kmn_cb,null,0,"kmn",null,0);var aj=this.createCreative(kmn_hb_options.kmn_sa_use_option,kmn_hb_options.kmn_sa_options,ah,ae,kmn_hb_options.kmn_sa_url);var af={cpm:0,height:ai?ai.height:0,width:ai?ai.width:0,placementid:ah,creative:aj};var ag={cpm:null,code:null,bid_src:"noavailbid",sent_bid:null,sbt:this.logicData.sbtMode};if(this.logicData.sbtMode){this.SaveBidToSbtBid(ah,af,ag)}else{this._callPBJSCallback(ah,af,ag)}}},{key:"_callPBJSCallback",value:function S(ah,ae,af,ag){ag=ag||"";if(this.logicData.hb_placement_bidids&&this.logicData.hb_placement_bidids[ah]){ae.bidid=this.logicData.hb_placement_bidids[ah]}if(this.logicData.callback){this.logicData.callback(ae);af.bid_ts=this._logic_tp();this._registerBidLog(ah,af);if(this.logicData.spark_sent){this._sendLogicEndSpark(true)}KmnUtils.logIfNeededStringify("bids_Logic: kmn bid data sent to prebid "+ag+":",ae)}else{KmnUtils.logIfNeededStringify("bids_Logic: no pbjs callbck! for "+ah)}}},{key:"SaveBidToSbtBid",value:function A(ag,ae,af){this.logicData.data[ag].sbtBid=ae;this.logicData.data[ag].sbtBidLog=af}},{key:"_registerBidLog",value:function h(af,ae){if(typeof this.logicData.data[af].bidsLog=="undefined"){this.logicData.data[af].bidsLog=[]}this.logicData.data[af].bidsLog.push(ae)}},{key:"_sentBidsCount",value:function ad(af){var ae=arguments.length>1&&arguments[1]!==undefined?arguments[1]:true;if(!this.logicData.data[af]||typeof this.logicData.data[af].bidsLog=="undefined"){return 0}return ae?this.logicData.data[af].bidsLog.length:this.logicData.data[af].bidsLog.filter(function(ag){return ag.cpm>0}).length}},{key:"_wrapWithScript",value:function V(ae){return"<script>"+ae+"<\/script>"}},{key:"_encodeHbData",value:function d(af){var ae=JSON.stringify(af);return encodeURIComponent(ae)}},{key:"_generateHdbdJson",value:function v(ae,aj,ah,ag,ai,af){return{cb:ae,winning_tag:aj,winning_bid:ah,bid_src:ag,sent_bid:af,creative_data:this._encodeHbData(ai)}}},{key:"createCreative",value:function a(ag,ai,aj,al,ak){var af=ag?this._wrapWithScript("var kmn_options =  "+JSON.stringify(ai)+"; "):"";var ah=this._wrapWithScript("var kmn_hb_data =  {};kmn_placement = '"+aj+"';kmn_hb_data['"+aj+"']="+JSON.stringify(al));var ae=this._wrapWithScript("kmn_hb_data['"+aj+"'].creative_data = decodeURIComponent(kmn_hb_data['"+aj+"'].creative_data); var script = document.createElement(\"script\");script.src = '"+ak+"';document.write(script.outerHTML);");if(this.logicData.encode_bid){return encodeURIComponent(""+af+ah+ae)}return""+af+ah+ae}},{key:"_logic_tp",value:function k(){var ae=KmnUtils.kmn_ts();return ae-this.logicData.start_time}},{key:"startLogicSparkTimeout",value:function g(){var ae=this;setTimeout(function(){ae._sendLogicEndSpark(true)},kmn_hb_options.prebidTimeout+200)}},{key:"_sendLogicEndSpark",value:function L(ag){if(ag||this.getBidstore()._didAllReturn()){if(!this.logicData.endCount){this.logicData.endCount=0}this.logicData.endCount++;this.logicData.spark_sent=true;var af=this._buildSparkStoreParams();var ae=this._buildSparkBidParams();af.pbsBids=ae.pbsBids;af.rb_data=this._buildSparkReuseBidsParams();af.kbend=1;af.hbtype="kbidder";af.ct=this.logicData.endCount;KmnUtils.spark(af)}}},{key:"_buildSparkBidParams",value:function w(){var ag=this;var ae={};var af={};Object.keys(this.logicData.data).forEach(function(ai){var ah=ag.logicData.data[ai];if(typeof ah.bidsLog!=="undefined"){af[ai]=ah.bidsLog}});ae.pbsBids=JSON.stringify(af);return ae}},{key:"_bidsStoreObjToStatData",value:function b(aj){var ai={};for(var ae in aj){if(aj.hasOwnProperty(ae)){var ag=aj[ae];ai[ae]={};for(var ah in ag){if(ag.hasOwnProperty(ah)){var af=ag[ah];ai[ae][ah]={net:af.network,ret:af.returned,reqts:af.reqts,rests:af.rests};KmnUtils.mAddIfExists(ai[ae][ah],af,["cpm","rb","gap","nap","fp","spt"]);if(af.creative_data&&af.creative_data.cpm_second){ai[ae][ah].cpm_s=af.creative_data.cpm_second}if(af.filtering){this._fillFilteringParamsToSpark(ai[ae][ah],af.filtering)}}}}}return ai}},{key:"_fillFilteringParamsArrayToSpark",value:function p(af,ae){if(ae){af.fl=JSON.stringify(ae.map(function(ag){return ag.fl}));af.flr=JSON.stringify(ae.map(function(ag){return ag.flr?ag.flr:""}));af.flm=JSON.stringify(ae.map(function(ag){return ag.flm?ag.flm:""}))}}},{key:"_fillFilteringParamsToSpark",value:function Q(af,ae){if(ae){af.fl=ae.fl;if(ae.fl){af.flr=ae.flr}if(ae.flm){af.flm=ae.flm}}}},{key:"_buildSparkReuseBidsParams",value:function j(){try{if(this.getBidstore()){var ae=this.getBidstore().getBidstoreData();if(ae&&ae.rb){return JSON.stringify(ae.rb)}}}catch(af){KmnUtils.spark({err:"failed@_buildSparkReuseBidsParams",msg:af.message})}return""}},{key:"_buildSparkStoreParams",value:function R(){var ae={};if(this.getBidstore()){var af=this.getBidstore().getBidstoreData();ae.kb_pl=Object.keys(af.placements).join(",");var ah=af.placements;var ag=this._bidsStoreObjToStatData(ah);ag.hb_tp=this._logic_tp();ae.hb_dl=JSON.stringify(ag)}return ae}}],[{key:"start",value:function H(ae){var ag=new t();ag.setConfig(ae);window.kmn_bids_store.setStartTime(ag.logicData.start_time);var af={kbstart:1,prebidtimeout:kmn_hb_options.prebidTimeout,hb_tp:ag._logic_tp(),kb_pl:ag.getConfigPlacementIds(),hbtype:"kbidder"};if(ag.logicData.hb_floors){af.floors=JSON.stringify(ag.logicData.hb_floors)}if(ImpressionFilter.shouldBlockByExternalNotification()){af.flbl=1}KmnUtils.spark(af);return ag}}]);return t}();var ReuseBid=function(){function h(){_classCallCheck(this,h)}_createClass(h,null,[{key:"addParamsForReuse",value:function a(j){j.bid_ts=KmnUtils.kmn_ts();j.bid_url=KmnUtils.site_url();return j}},{key:"storageSupported",value:function d(){return KmnUtils.isSessionStorageUsable()}},{key:"loadAllFromStorage",value:function i(){if(!h.storageSupported()){KmnUtils.log("SessionStorage not supported");return{}}var j=sessionStorage.getItem(h.KEY);var k={};if(j){try{k=JSON.parse(j)}catch(l){}}return k}},{key:"filterByPlacements",value:function c(k,j){KmnUtils.log("ReuseBid: Filtering only to fit to placements: "+j);return Object.keys(k).filter(function(l){return j.indexOf(l)!==-1}).reduce(function(l,m){l[m]=k[m];return l},{})}},{key:"filterByTimePassed",value:function g(k,n,m){KmnUtils.log("ReuseBid: Filtering only to fit to the last "+n+" seconds and for the same url more than "+m+" seconds");var l=KmnUtils.kmn_ts();var p=l-n*1000;var r=void 0;if(m){r=l-m*1000}var t=KmnUtils.site_url();for(var q in k){if(k.hasOwnProperty(q)){var s=k[q];for(var j in s){if(s.hasOwnProperty(j)){var o=s[j];if(o.bid_ts<p){KmnUtils.log("ReuseBid: Filtering out because "+j+" passed more than "+n);delete k[q][j]}else{if(r&&o.bid_url===t&&o.bid_ts>r){KmnUtils.log("ReuseBid: Filtering out because "+j+" has same url and not passed enough time "+m);delete k[q][j]}}}}if(Object.keys(k[q]).length==0){delete k[q]}}}return k}},{key:"deleteBidFromObject",value:function f(m,l,k){KmnUtils.log("ReuseBid: deleting bid from object. placement id is "+l+" bidid is "+k);if(m[l]&&m[l][k]){delete m[l][k];return m}else{var j="ReuseBid: FAILED deleting bid from object - no such bid. placement id is "+l+" bidid is "+k;KmnUtils.log(j);KmnUtils.spark({err:"failed@deleteBidFromObject",msg:j});return null}}},{key:"saveBidsToStorage",value:function b(j){KmnUtils.logIfNeededStringify("ReuseBid: Adding to sessionStorage: ",j);var k=h.loadAllFromStorage();k=h.filterByTimePassed(k,h.minSecsToReuseBid);j.filter(function(l){return l.cpm>0}).forEach(function(m){var n=m.placementid;var l=m.bid_id;if(!k[n]){k[n]={}}k[n][l]=m});h.saveAllToStorage(k)}},{key:"saveAllToStorage",value:function e(j){if(!h.storageSupported()){KmnUtils.log("SessionStorage not supported");return}var k=JSON.stringify(j);sessionStorage.setItem(h.KEY,k)}}]);return h}();ReuseBid.KEY="kmn_rb";ReuseBid.minSecsToReuseBid=60;var ImpressionFilter=function(){function d(){_classCallCheck(this,d)}_createClass(d,null,[{key:"block",value:function l(A){var z={blocked:true,why:A};d._loadUpdateAndSave("updateBlocked",z)}},{key:"blockNw",value:function k(C,z,B){var A={blocked:true,why:C,placement:z,network:B};d._loadUpdateAndSave("updateNwBlocked",A)}},{key:"unblock",value:function i(){var A={blocked:false};var z=1*24*3600*1000;A.until=DateManip.now()+z;var B=d._getCurrentFilteringData();B.updateBlocked(A);d._saveFilteringData(B)}},{key:"updateNetworkResponse",value:function e(B,z,A){var C=d._getCurrentFilteringData();C.updateNetworkResponse(B,z,A);d._saveFilteringData(C)}},{key:"updateGlobalCounterRequest",value:function c(z){d._updateGlobalCounter(z,true,false)}},{key:"updateGlobalCounterBid",value:function g(z){d._updateGlobalCounter(z,false,true)}},{key:"shouldSample",value:function r(A){var C=d._getCurrentFilteringData();var D=C.groupId();var B=false;if(A>=0&&A<=1){if(A===1){B=true}var z=Math.floor(1/A);if(D%z==0){B=true}}return B}},{key:"isBlocked",value:function q(A,z,B){var C=d._getCurrentFilteringData();return d._shouldBlock(C,A,B,z)}},{key:"isNwBlocked",value:function u(z,A){var B=d._getCurrentFilteringData();return d._shouldBlockNw(B,z,A)}},{key:"storageSupported",value:function a(){return KmnUtils.isLocalStorageUsable()}},{key:"_loadUpdateAndSave",value:function t(z,A){A.until=d._blockUntil(A.why);var B=d._getCurrentFilteringData();if(B[z]){B[z](A)}d._saveFilteringData(B)}},{key:"_blockUntil",value:function y(z){var B=d.maxDays[z]||d.maxDays.pageLevel;var A=B*24*3600*1000;return DateManip.now()+A}},{key:"_updateGlobalCounter",value:function v(z,B,A){var C=d._getCurrentFilteringData();C.updateNetworkData("any",z,B,A);d._saveFilteringData(C)}},{key:"_getCurrentFilteringData",value:function o(){var z=d._loadFilteringData();if(z){d._filterDataByDate(z);return z}return new ImpressionFilterData()}},{key:"_validateBlockedUntilTime",value:function w(A){var z=DateManip.now();if(A&&z-A<0){return true}return false}},{key:"_filterDataByDate",value:function b(z){z.filterCountersByDate();z.filterBlockedByDate()}},{key:"_shouldBlock",value:function s(D,B,C,A){var F=d.shouldBlockByExternalNotification(D);var z=d._shouldBlockByTs(B,C);var E=z||F;if(A&&(typeof A==="undefined"?"undefined":_typeof(A))==="object"){d._explain(A,D,z,F)}return E}},{key:"_shouldBlockNw",value:function n(D,B,C,A){var E=false;if(D){var z=D.getNwBlockedStatus(B,C);if(z){E=z.blocked&&d._validateBlockedUntilTime(z.until)}}return E}},{key:"shouldBlockByExternalNotification",value:function j(){var z=arguments.length>0&&arguments[0]!==undefined?arguments[0]:d._getCurrentFilteringData();return z&&z.getData().blocked&&z.getData().until&&d._validateBlockedUntilTime(z.getData().until)}},{key:"_shouldBlockByTs",value:function h(A,B){var z=false;if(A&&A.methods&&A.methods.ts&&A.methods.ts.level>0){var C=A.methods.ts.config;if(C&&C.tsth){z=B>C.tsth}}return z}},{key:"_explain",value:function x(A,C,z,D){var B={ts:z};if(D&&C.getData().why){B[C.getData().why]=D}A.counters=C.getAllCountsPerNetwork();A.data=B}},{key:"_loadFilteringData",value:function f(){var z=void 0;if(d.storageSupported()){var B=d._getStorage();if(B){var A=B.getItem(d.KEY);if(A){z=new ImpressionFilterData();z.fromJson(A)}}}return z}},{key:"_saveFilteringData",value:function p(z){if(d.storageSupported()){var A=d._getStorage();if(A){A.setItem(d.KEY,z.asJson())}}}},{key:"_getStorage",value:function m(){return window.localStorage}}]);return d}();ImpressionFilter.KEY="kmn_fl";ImpressionFilter.maxDays={pageLevel:10,npc:1};var ImpressionFilterData=function(){function m(){_classCallCheck(this,m);this.data={};this.data.blocked=false;this.data.until=null;this.data.why="";this.data.blockedNw={};this.data.counters={};this.data.group=this._createGroupId()}_createClass(m,[{key:"asJson",value:function a(){return JSON.stringify(this.data)}},{key:"fromJson",value:function f(p){if(p){try{this.data=JSON.parse(p);if(typeof this.data.group=="undefined"){this.data.group=this._createGroupId()}}catch(q){return false}}return true}},{key:"getData",value:function g(){return this.data}},{key:"updateBlocked",value:function o(p){if(typeof p.blocked!=="undefined"){this.data.blocked=p.blocked;this.data.until=p.until;if(this.data.blocked){this.data.why=p.why}else{delete this.data.why}}}},{key:"updateNwBlocked",value:function h(p){if(p&&p.placement&&p.network&&typeof p.blocked!=="undefined"){if(p.blocked){var q={blocked:true,why:p.why,until:p.until};KmnUtils.vivify(this.data,["blockedNw",p.placement,p.network],q,true)}else{if(this.data.blockedNw&&this.data.blockedNw[p.placement]){delete this.data.blockedNw[p.placement][p.network]}}}}},{key:"updateNetworkResponse",value:function k(r,p,q){var s=arguments.length>3&&arguments[3]!==undefined?arguments[3]:DateManip.today();this.updateNetworkData(r,p,true,q,s)}},{key:"updateNetworkData",value:function n(q,p,t,r){var u=arguments.length>4&&arguments[4]!==undefined?arguments[4]:DateManip.today();KmnUtils.vivify(this.data,["counters",q,u,p,"res"],0);KmnUtils.vivify(this.data,["counters",q,u,p,"wb"],0);var s=this.data.counters[q][u][p];if(t){s.res++}if(r){s.wb++}}},{key:"_getCountsPerNetwork",value:function i(q){var p={};if(this.data&&this.data.counters&&this.data.counters[q]){var r=this.data.counters[q];Object.keys(r).forEach(function(s){var t=r[s];Object.keys(t).forEach(function(u){var v=t[u];if(!p[u]){p[u]={res:0,wb:0}}p[u].res+=v.res;if(v.wb){p[u].wb+=v.wb}})})}return p}},{key:"getAllCountsPerNetwork",value:function e(){var q=this;var p={};if(this.data&&this.data.counters){Object.keys(this.data.counters).forEach(function(r){p[r]=q._getCountsPerNetwork(r)})}return p}},{key:"filterCountersByDate",value:function d(){var r=arguments.length>0&&arguments[0]!==undefined?arguments[0]:ImpressionFilter.maxDays.npc;var p=arguments.length>1&&arguments[1]!==undefined?arguments[1]:DateManip.today();if(this.data&&this.data.counters){var q=this.data.counters;Object.keys(q).forEach(function(s){q[s]=KmnUtils.filterObj(q[s],function(t){return DateManip.dayDiff(t,DateManip.daysAgo(p,r))>0})})}}},{key:"filterBlockedByDate",value:function l(){if(this.data&&this.data.blockedNw){var p=this.data.blockedNw;Object.keys(p).forEach(function(q){p[q]=KmnUtils.filterObj(p[q],function(r){return ImpressionFilter._validateBlockedUntilTime(p[q][r].until)})});p=KmnUtils.filterObj(p,function(q){return Object.keys(p[q]).length>0})}}},{key:"getNwBlockedStatus",value:function b(p,q){return KmnUtils.getPath(["blockedNw",p,q],this.data)||{blocked:false}}},{key:"_createGroupId",value:function j(){return Math.floor(Math.random()*10000000)}},{key:"groupId",value:function c(){return this.data.group}}]);return m}();var ImpressionFilterLogic=function(){function n(u,s){_classCallCheck(this,n);this._globalConfig=u;var t={};this._isPageFiltered=ImpressionFilter.isBlocked(this._globalConfig,t,s);this._pageLevelExplanation=t.data;this._npcCounters=t.counters;this._unsampled={qf:true};this._flOrder=[{name:"qf",type:"page"},{name:"gf",type:"page"},{name:"ts",type:"page"},{name:"npc",type:"nw"},{name:"npr",type:"nw"}];this.flOrder=[2,1,3,0]}_createClass(n,[{key:"apply",value:function j(w,z){var y=this;var x={};var u=this._shouldSamplePlacement(w);Object.keys(this._pageLevelExplanation).forEach(function(B){if(y._pageLevelExplanation[B]){var A=y._getMethodActivation(B);y._setFilteringLevel(x,B,A,u)}});if(z){var t=this._getConfigForSlot(w,z);var v=this._shouldSampleCode(t);this._flOrder.filter(function(A){return A.type==="nw"}).forEach(function(D){var C=D.name;var B=y._getMethodActivation(C,t);if(B>0){var A=y.applyMethod(C,t,z);if(A){y._setFilteringLevel(x,C,B,v)}}})}var s=this._resultFromFlm(x,z);return s}},{key:"applyMethod",value:function c(u,s,t){switch(u){case"npc":return this.applyNpc(s,t);case"npr":return this.applyNpr(s,t)}return null}},{key:"applyNpc",value:function m(s,t){var v=false;var u=this._getMethodActivation("npc",s);if(u>0&&t&&t.placement&&t.network){if(this._applyNpcByBlocked(t)){v=true}else{if(this._applyNpcByCounters(s,t)){v=true;ImpressionFilter.blockNw("npc",t.placement,t.network)}}}return v}},{key:"_applyNpcByCounters",value:function q(u,z){var v=KmnUtils.getPath(["methods","npc","npcc"],u);var t=KmnUtils.getPath(["methods","npc","npcth"],u);if(v!==null&&t!==null&&t>=0){var s=z.placement;var y=z.network;if(!this._npcCounters||!this._npcCounters[y]||!this._npcCounters[y][s]){return false}var w=this._npcCounters[y][s];var x=this._getRatioBidToRes(w);if(w.res>v&&x<=t){return true}}return false}},{key:"_applyNpcByBlocked",value:function e(s){return ImpressionFilter.isNwBlocked(s.placement,s.network)}},{key:"_getRatioBidToRes",value:function r(s){if(!s){return 1}var u=parseFloat(s.wb);var t=parseFloat(s.res);if(isNaN(u)||isNaN(t)){return 1}return u/t}},{key:"applyNpr",value:function f(s){return s&&s.methods&&s.methods.npr}},{key:"_getMethodFl",value:function a(v,s,t){var u=void 0;if(t&&!this._unsampled[v]){u=3}else{u=s}return u}},{key:"_setFilteringLevel",value:function k(u,w,s,t){if(u){var v=this._getMethodFl(w,s,t);if(v!==0){u[w]={fl:v}}}}},{key:"_getConfigForSlot",value:function h(s,t){if(s&&s.codes&&t&&t.code){var u=s.codes.filter(function(v){return v.code===t.code});if(u.length>0){return u[0]}}return null}},{key:"_resultFromFlm",value:function o(u,t){var s=this;var v={fl:0,flr:"",flm:u?u:{}};if(u){this._flOrder.forEach(function(x){var w=x.name;if(u[w]&&s._gt(u[w].fl,v.fl)){v.fl=u[w].fl;v.flr=w}})}if(t&&t.placement&&KmnUtils.getPath([t.network,t.placement],this._npcCounters)&&Object.keys(this._npcCounters[t.network][t.placement]).length>0){if(!v.flm.npc){v.flm.npc={}}if(!v.flm.npc.data){v.flm.npc.data={}}v.flm.npc.data.counters=this._npcCounters[t.network][t.placement]}v.isFiltered=v.fl===2;return v}},{key:"_gt",value:function d(t,s){return this.flOrder.indexOf(t)<this.flOrder.indexOf(s)}},{key:"_shouldSamplePlacement",value:function p(s){var t=s&&s.config&&s.config.sample?s.config.sample:0;return ImpressionFilter.shouldSample(t)}},{key:"_shouldSampleCode",value:function i(s){var t=s&&s.sample?s.sample:0;return ImpressionFilter.shouldSample(t)}},{key:"_getMethodActivation",value:function b(u,s){var t=this._globalConfig&&this._globalConfig.methods&&this._globalConfig.methods[u]&&this._globalConfig.methods[u].level?this._globalConfig.methods[u].level:0;if(s&&s.methods&&!s.methods[u]){t=0}return t}},{key:"isPageFiltered",value:function l(){return this._isPageFiltered}},{key:"pageLevelExplanation",value:function g(){return this._pageLevelExplanation}}]);return n}();var DateManip=function(){function f(){_classCallCheck(this,f)}_createClass(f,null,[{key:"today",value:function b(){return f.dateObjToDateStr(new Date())}},{key:"now",value:function c(){return new Date().getTime()}},{key:"daysAgo",value:function e(j,m){var i=f.dateStrToDateObj(j);var l=new Date(new Date().setTime(i.getTime()-m*24*3600*1000));var k=f.dateObjToDateStr(l);return k}},{key:"dayDiff",value:function d(j,i){var l=f.dateStrToDateObj(j);var k=f.dateStrToDateObj(i);if(l&&k){return Math.floor((l-k)/(1000*60*60*24))}return 0}},{key:"_addZ",value:function h(i){return(i<10?"0":"")+i}},{key:"dateObjToDateStr",value:function g(i){if(i){return i.getFullYear()+"-"+f._addZ(i.getMonth()+1)+"-"+f._addZ(i.getDate())}return null}},{key:"dateStrToDateObj",value:function a(i){if(i){var j=i.split("-");if(j.length==3){return new Date(j[0],j[1]-1,j[2])}}return null}}]);return f}();if(window.kmn_hbid){KmnKB.start()};